## Deployer

Polls a central application configuration repository for application
configuration and code updates.

The result of this polling is a directory of arbitrary application files,
which the application container installed on the server image is
expected to monitor for updates.

The directory to monitor is located at `${deployDir}/current`. By
default, this resolves to `/var/deploy/current`. Alternate
locations can be specified in `/etc/repo-deploy/repo-deploy.cfg`.

### Command line parameters

```
usage: repo-deploy [-h] [-c CONFIG] [--pre-hooks PRE_HOOKS]
                [--post-hooks POST_HOOKS] [-i ID] [-d DIRECTORY] [-f] [-v]

optional arguments:
  -h, --help            show this help message and exit
  -c CONFIG, --config CONFIG
                        Configuration file
  --pre-hooks PRE_HOOKS
                        Pre-update script hooks directory
  --post-hooks POST_HOOKS
                        Post-update script hooks directory
  -i ID, --id ID        Application identity
  -d DIRECTORY, --directory DIRECTORY
                        Deployer directory
  -f, --fetch           Fetch config once and exit
  -v, --verbose         Verbose logging for debugging
```

### /etc/repo-deploy/repo-deploy.cfg options:

Option | Value
-------|-------
*repository* | The configuration repository URL. Currently supports `s3`, `http(s)`, and `git` (see below for details)
*directory* | The deployer home directory. Defaults to `/var/repo-deploy`
*identity* | The application identity to fetch configuration for. If omitted, deployer will attempt to detect it automatically (see below)
*schedule* | A cron-like schedule string that configures when the deployer will check for updates (ignored if run with `-f`)

### Repository formats

#### HTTP/S repositories

HTTP repositories have a flat structure. With a repository of `http://apps.barchart.com/config`
and an application identity of `karaf.news.dev.feed`, the repository should contain a file at
`http://apps.barchart.com/config/karaf.news.dev.feed.zip`. This ZIP file will be unpacked as
the configuration directory.

#### S3 repositories

S3 repositories have the same flat structure of HTTP repositories. The URL should be of the
form `s3://bucket/prefix`. For non-public buckets, you can specify credentials in several
different ways:

1. Use IAM instance roles to automatically provide credentials (preferred)

2. Save the credentials to `~deploy/.amazon/account-key`, with the following format:

```
accessKey=XXX
secretKey=XXX
```

3. Specify the access key and secret key in `/etc/repo-deploy/repo-deploy.cfg`

```
aws-access-key=XXX
aws-secret-key=XXX
```

#### Git repositories

Git repositories have a heirarchical directory structure for better organization since
they are more likely to be human-maintained. With a repository of
`git@github.com:barchart/barchart-applications.git` and an application identity of
`php.www.prod`, the repository should have the following structure:

```
/php
   /www
      /prod
	     <code/configuration files here>
```

Configuration should not be compressed in a ZIP file for Git repositories, unlike S3/HTTP.

### Identity providers

#### EC2 user-data

If the instance is hosted on EC2 (determined by attempting a DNS lookup for
instance-data.ec2.internal), the identity can be provided via the instance user-data.
The user-data should be a JSON document, with the application identity provided in the
"identity" field:

```json
{ "identity": "karaf.news.prod.feed" }
```

#### Machine hostname

If no EC2 user data is found and the hostname is set, the identity will be generated by reversing the local domain segments (to preserve application hierarchies in the repository.) So a hostname of `app.barchart.com` would generate an application identity of `com.barchart.app`.

### Pre/Post update hooks

For application-specific update processes, you can bundle pre-and-post-update hook scripts
in the deployer machine image. These scripts go in `/etc/repo-deploy/pre-update.d` and
`/etc/repo-deploy/post-update.d`. Any executable file in these directories will be run before or
after a code update happens.

#### Environment variables

Two environment variables are passed to script hooks to allow hooks to intelligently compare
configuration changes:

* `CURRENT_CONFIG` The current (new) configuration directory
* `PREVIOUS_CONFIG` The previous (existing) configuration directory

#### Return values

A non-zero return value indicates that the current update should be blocked (for pre-update
hooks) or reverted (for post-update hooks). The update will be tried again on the next
scheduled check (default 60 seconds.)  This behavior should only be used in exceptional cases
(i.e. the app is in an unstable state) rather than as a scheduling mechanism. Scheduling
should be handled by cron (with `-f` command line parameter) or the "schedule" configuration
 variable.

#### Use cases 

Pre-update hooks can be used to:

* block updates until the application is in an updatable state
* acquire a distributed update lock to facilitate rolling updates in a cluster

Post-update hooks can be used to:

* move files to the correct locations
* reload/restart the application
* verify service health
* release a distributed rolling update lock
